name: Discord Notification - PR Closed

on:
  pull_request:
    types: [closed]

jobs:
  notify:
    if: github.event.pull_request.base.ref == 'develop'
    runs-on: ubuntu-latest
    steps:
      - name: Send PR Closed Notification
        shell: bash
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          TITLE="${{ github.event.pull_request.title }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          AVATAR_URL="${{ github.event.pull_request.user.avatar_url }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          MERGED="${{ github.event.pull_request.merged }}"
          MERGED_BY="${{ github.event.pull_request.merged_by.login }}"

          if [ "$MERGED" = "true" ]; then
            COLOR_HEX="2ebd85"
            EMOJI="ðŸ”€"
            CONTENT="$EMOJI **#${PR_NUMBER} PRì´ develop ë¸Œëžœì¹˜ì— ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤.**"
            FIELD_NAME="Merged by"
            FIELD_VALUE="@${MERGED_BY}"
          else
            COLOR_HEX="ff5c5c"
            EMOJI="âŒ"
            CONTENT="$EMOJI **#${PR_NUMBER} PRì´ ë‹«í˜”ìŠµë‹ˆë‹¤.**"
            FIELD_NAME=""
            FIELD_VALUE=""
          fi

          COLOR_DEC=$((16#${COLOR_HEX}))

          if [ "$MERGED" = "true" ]; then
            FIELDS=$(jq -n --arg name "$FIELD_NAME" --arg value "$FIELD_VALUE" '[
              {
                name: $name,
                value: $value,
                inline: true
              }
            ]')
          else
            FIELDS="[]"
          fi

          jq -n \
            --arg username "GitHub PR Bot" \
            --arg avatar_url "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg content "$CONTENT" \
            --arg author "$AUTHOR" \
            --arg author_icon "$AVATAR_URL" \
            --arg title "$TITLE" \
            --arg url "$PR_URL" \
            --argjson color "$COLOR_DEC" \
            --argjson fields "$FIELDS" \
            '{
              username: $username,
              avatar_url: $avatar_url,
              content: $content,
              embeds: [{
                author: {
                  name: $author,
                  icon_url: $author_icon
                },
                title: $title,
                url: $url,
                color: $color,
                fields: $fields
              }]
            }' > payload.json

          curl -H "Content-Type: application/json" \
            -X POST \
            -d @payload.json \
            "$WEBHOOK_URL"
