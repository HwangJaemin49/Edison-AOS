name: Discord Notification - PR Review Requested

on:
  pull_request:
    types: [review_requested]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Reviewer
        shell: bash
        env:
          DISCORD_ID_MAP: ${{ secrets.DISCORD_ID_MAP }}
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          BODY="${{ github.event.pull_request.body }}"
          SENDER="${{ github.event.sender.login }}"
          REVIEWER="${{ github.event.requested_reviewer.login }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          AVATAR_URL="${{ github.event.pull_request.user.avatar_url }}"

          get_discord_mention() {
            local github_id=$1
            local discord_id=$(echo "$DISCORD_ID_MAP" | jq -r --arg key "$github_id" '.[$key]')
            if [ "$discord_id" = "null" ]; then
              echo "\`@$github_id\`"
            else
              echo "<@$discord_id>"
            fi
          }

          REVIEWER_MENTION=$(get_discord_mention "$REVIEWER")
          SENDER_MENTION=$(get_discord_mention "$SENDER")

          if [ -z "$BODY" ]; then
            DESCRIPTION="(No description provided)"
          else
            DESCRIPTION="\n$BODY"
          fi

          CONTENT="ðŸ“¬ ${SENDER_MENTION} ë‹˜ì´ ${REVIEWER_MENTION} ë‹˜ì—ê²Œ #${PR_NUMBER} PRì— ëŒ€í•œ ë¦¬ë·°ë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤."

          jq -n \
            --arg username "GitHub Review Bot" \
            --arg avatar_url "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg content "**$CONTENT**" \
            --arg author "$AUTHOR" \
            --arg author_icon "$AVATAR_URL" \
            --arg title "$PR_TITLE" \
            --arg url "$PR_URL" \
            --arg description "$DESCRIPTION" \
            --argjson color 3447003 \
            '{
              username: $username,
              avatar_url: $avatar_url,
              content: $content,
              embeds: [{
                author: {
                  name: $author,
                  icon_url: $author_icon
                },
                title: $title,
                url: $url,
                description: $description,
                color: $color
              }]
            }' > payload.json

          curl -H "Content-Type: application/json" \
            -X POST \
            -d @payload.json \
            "$WEBHOOK_URL"
