name: Discord Notification - PR Review Requested

on:
  pull_request:
    types: [review_requested]

  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Î≤àÌò∏'
        required: true
      pr_title:
        description: 'PR Ï†úÎ™©'
        required: true
      pr_url:
        description: 'PR ÎßÅÌÅ¨'
        required: true
      body:
        description: 'PR Î≥∏Î¨∏'
        required: false
      sender:
        description: 'ÏöîÏ≤≠Ïûê GitHub ID'
        required: true
      reviewer:
        description: 'Î¶¨Î∑∞ ÏöîÏ≤≠ Î∞õÏùÄ ÏÇ¨Îûå GitHub ID'
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Reviewer
        shell: bash
        env:
          DISCORD_ID_MAP: ${{ secrets.DISCORD_ID_MAP }}
        run: |
          PR_NUMBER="${{ github.event.inputs.pr_number }}"
          PR_TITLE="${{ github.event.inputs.pr_title }}"
          PR_URL="${{ github.event.inputs.pr_url }}"
          SENDER="${{ github.event.inputs.sender }}"
          REVIEWER="${{ github.event.inputs.reviewer }}"
          BODY="${{ github.event.inputs.body }}"
          WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"

          get_discord_mention() {
            local github_id=$1
            local discord_id=$(echo "$DISCORD_ID_MAP" | jq -r --arg key "$github_id" '.[$key]')
            if [ "$discord_id" = "null" ]; then
              echo "\`$github_id\`"
            else
              echo "<@$discord_id>"
            fi
          }

          REVIEWER_MENTION=$(get_discord_mention "$REVIEWER")
          SENDER_MENTION="\`$SENDER\`"

          if [ -z "$BODY" ]; then
            BODY="(No description provided)"
          fi

          BODY="\`\`\`markdown\n$BODY\n\`\`\`"
          CONTENT="**üì¨ ${SENDER_MENTION} ÎãòÏù¥ ${REVIEWER_MENTION} ÎãòÏóêÍ≤å #${PR_NUMBER} PRÏóê ÎåÄÌïú Î¶¨Î∑∞Î•º ÏöîÏ≤≠ÌñàÏäµÎãàÎã§.**"

          echo '{
            "username": "GitHub Review Bot",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "content": "'"${CONTENT}"'",
            "embeds": [{
              "title": "'"${PR_TITLE}"'",
              "url": "'"${PR_URL}"'",
              "description": "'"${BODY}"'",
              "color": 3447003
            }]
          }' > payload.json

          curl -H "Content-Type: application/json" \
            -X POST \
            -d @payload.json \
            "$WEBHOOK_URL"
