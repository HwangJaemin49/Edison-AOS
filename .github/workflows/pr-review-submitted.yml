name: Discord Notification - PR Review Submitted

on:
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      COMMENT_RAW: ${{ github.event.review.body }}
    steps:
      - name: Notify Review Submission
        shell: bash
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          REVIEWER="${{ github.event.review.user.login }}"
          STATE="${{ github.event.review.state }}"
          WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"

          # ì½”ë©˜íŠ¸ escape
          if [ -z "$COMMENT_RAW" ]; then
            COMMENT=""
          else
            COMMENT_ESCAPED=$(printf "%s" "$COMMENT_RAW" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
            COMMENT="```${COMMENT_ESCAPED}```"
          fi

          # ìƒíƒœë³„ ë©”ì‹œì§€
          if [ "$STATE" = "approved" ]; then
            CONTENT="âœ… \`${REVIEWER}\` ë‹˜ì´ #${PR_NUMBER} PRì„ ìŠ¹ì¸í–ˆìŠµë‹ˆë‹¤."
            COLOR=2ebd85
          elif [ "$STATE" = "changes_requested" ]; then
            CONTENT="ðŸš« \`${REVIEWER}\` ë‹˜ì´ #${PR_NUMBER} PRì— ëŒ€í•´ ìˆ˜ì •ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤."
            COLOR=ff5c5c
          elif [ "$STATE" = "commented" ]; then
            CONTENT="ðŸ’¬ \`${REVIEWER}\` ë‹˜ì´ #${PR_NUMBER} PRì— ëŒ€í•´ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê²¼ìŠµë‹ˆë‹¤."
            COLOR=999999
          else
            CONTENT="ðŸ“¤ \`${REVIEWER}\` ë‹˜ì´ #${PR_NUMBER} PRì— ëŒ€í•œ ë¦¬ë·°ë¥¼ ì œì¶œí–ˆìŠµë‹ˆë‹¤."
            COLOR=cccccc
          fi

          echo '{
            "username": "GitHub Review Bot",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "content": "'"${CONTENT}"'",
            "embeds": [{
              "title": "'"${PR_TITLE}"'",
              "url": "'"${PR_URL}"'",
              "description": "'"${COMMENT}"'",
              "color": '"$COLOR"'
            }]
          }' > payload.json

          curl -H "Content-Type: application/json" \
            -X POST \
            -d @payload.json \
            "$WEBHOOK_URL"
