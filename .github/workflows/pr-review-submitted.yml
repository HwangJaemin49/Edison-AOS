name: Discord Notification - PR Review Submitted

on:
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      DISCORD_ID_MAP: ${{ secrets.DISCORD_ID_MAP }}
      WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    steps:
      - name: Notify Review Submission
        shell: bash
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          REVIEWER="${{ github.event.review.user.login }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          COMMENT="${{ github.event.review.body }}"
          STATE="${{ github.event.review.state }}"

          get_discord_mention() {
            local github_id=$1
            local discord_id=$(echo "$DISCORD_ID_MAP" | jq -r --arg key "$github_id" '.[$key]')
            if [ "$discord_id" = "null" ]; then
              echo "\`@$github_id\`"
            else
              echo "<@$discord_id>"
            fi
          }

          REVIEWER_MENTION=$(get_discord_mention "$REVIEWER")
          AUTHOR_MENTION=$(get_discord_mention "$AUTHOR")

          # ìƒíƒœë³„ ë©”ì‹œì§€ ë° ìƒ‰ìƒ ì„¤ì •
          if [ "$STATE" = "approved" ]; then
            ICON="âœ…"
            COLOR_HEX="2ebd85"
            ACTION="PRì„ ìŠ¹ì¸í–ˆìŠµë‹ˆë‹¤."
          elif [ "$STATE" = "changes_requested" ]; then
            ICON="ðŸš«"
            COLOR_HEX="ff5c5c"
            ACTION="PRì— ëŒ€í•´ ìˆ˜ì •ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤."
          elif [ "$STATE" = "commented" ]; then
            ICON="ðŸ’¬"
            COLOR_HEX="999999"
            ACTION="PRì— ëŒ€í•´ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê²¼ìŠµë‹ˆë‹¤."
          else
            ICON="ðŸ“¤"
            COLOR_HEX="cccccc"
            ACTION="PRì— ëŒ€í•œ ë¦¬ë·°ë¥¼ ì œì¶œí–ˆìŠµë‹ˆë‹¤."
          fi

          COLOR_DEC=$((16#${COLOR_HEX}))
          CONTENT="**${ICON} ${REVIEWER_MENTION} ë‹˜ì´ ${AUTHOR_MENTION} ë‹˜ì˜ #${PR_NUMBER} ${ACTION}**"

          if [ -z "$COMMENT" ]; then
            DESCRIPTION=""
          else
            DESCRIPTION="$COMMENT"
          fi

          jq -n \
            --arg username "GitHub Review Bot" \
            --arg avatar_url "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg content "$CONTENT" \
            --arg title "$PR_TITLE" \
            --arg url "$PR_URL" \
            --arg description "$DESCRIPTION" \
            --argjson color "$COLOR_DEC" \
            '{
              username: $username,
              avatar_url: $avatar_url,
              content: $content,
              embeds: [{
                title: $title,
                url: $url,
                description: $description,
                color: $color
              }]
            }' > payload.json

          curl -H "Content-Type: application/json" \
               -X POST \
               -d @payload.json \
               "$WEBHOOK_URL"
