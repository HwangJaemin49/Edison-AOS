name: Discord Notification - Issue Status

on:
  issues:
    types:
      - opened
      - reopened
      - closed

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Issue Notification
        shell: bash
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          TITLE="${{ github.event.issue.title }}"
          AUTHOR="${{ github.event.issue.user.login }}"
          AVATAR_URL="${{ github.event.issue.user.avatar_url }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          BODY="${{ github.event.issue.body }}"
          ACTION="${{ github.event.action }}"  # opened, reopened, closed

          # ìƒ‰ìƒ ì„¤ì •
          if [ "$ACTION" = "closed" ]; then
            COLOR_HEX="444444"
            EMOJI="ðŸ§©"
            VERB="ì´ìŠˆê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."
          elif [ "$ACTION" = "reopened" ]; then
            COLOR_HEX="${{ github.event.issue.labels[0].color }}"
            EMOJI="ðŸ«§"
            VERB="ì´ìŠˆê°€ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤."
          elif [ "$ACTION" = "opened" ]; then
            COLOR_HEX="${{ github.event.issue.labels[0].color }}"
            EMOJI="ðŸ«§"
            VERB="ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            COLOR_HEX="808080"
            EMOJI="â”"
            VERB="ì´ìŠˆ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi

          if [ -z "$COLOR_HEX" ]; then
            COLOR_HEX="808080"
          fi
          COLOR_DEC=$((16#${COLOR_HEX}))

          # ë³¸ë¬¸ ì²˜ë¦¬
          if [ -z "$BODY" ]; then
            DESCRIPTION="(No description provided)"
          else
            DESCRIPTION="$(printf "\n%s" "$BODY")"
          fi

          jq -n \
            --arg username "GitHub Issue Bot" \
            --arg avatar_url "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg content "$EMOJI **#${ISSUE_NUMBER} ${VERB}**" \
            --arg author "$AUTHOR" \
            --arg author_icon "$AVATAR_URL" \
            --arg title "$TITLE" \
            --arg url "$ISSUE_URL" \
            --arg description "$DESCRIPTION" \
            --argjson color "$COLOR_DEC" \
            '{
              username: $username,
              avatar_url: $avatar_url,
              content: $content,
              embeds: [{
                author: {
                  name: $author,
                  icon_url: $author_icon
                },
                title: $title,
                url: $url,
                description: $description,
                color: $color
              }]
            }' > payload.json

          curl -H "Content-Type: application/json" \
            -X POST \
            -d @payload.json \
            "$WEBHOOK_URL"
